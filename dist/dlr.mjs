/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Label Recognizer JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 2.2.2 (js 20220302)
 * @fileoverview Dynamsoft JavaScript Library for Label Recognizer
 * More info on DLR JS: https://www.dynamsoft.com/label-recognizer/sdk-javascript/
 */
function e(e,t,i,s){return new(i||(i=Promise))((function(r,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function a(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((s=s.apply(e,t||[])).next())}))}var t,i,s;!function(e){e[e.IPF_BINARY=0]="IPF_BINARY",e[e.IPF_BINARYINVERTED=1]="IPF_BINARYINVERTED",e[e.IPF_GRAYSCALED=2]="IPF_GRAYSCALED",e[e.IPF_NV21=3]="IPF_NV21",e[e.IPF_RGB_565=4]="IPF_RGB_565",e[e.IPF_RGB_555=5]="IPF_RGB_555",e[e.IPF_RGB_888=6]="IPF_RGB_888",e[e.IPF_ARGB_8888=7]="IPF_ARGB_8888",e[e.IPF_RGB_161616=8]="IPF_RGB_161616",e[e.IPF_ARGB_16161616=9]="IPF_ARGB_16161616",e[e.IPF_ABGR_8888=10]="IPF_ABGR_8888",e[e.IPF_ABGR_16161616=11]="IPF_ABGR_16161616",e[e.IPF_BGR_888=12]="IPF_BGR_888"}(t||(t={})),function(e){e[e.OK=0]="OK",e[e.UNKNOWN=-1e4]="UNKNOWN",e[e.NO_MEMORY=-10001]="NO_MEMORY",e[e.NULL_POINTER=-10002]="NULL_POINTER",e[e.LICENSE_INVALID=-10003]="LICENSE_INVALID",e[e.LICENSE_EXPIRED=-10004]="LICENSE_EXPIRED",e[e.FILE_NOT_FOUND=-10005]="FILE_NOT_FOUND",e[e.FILETYPE_NOT_SUPPORTED=-10006]="FILETYPE_NOT_SUPPORTED",e[e.BPP_NOT_SUPPORTED=-10007]="BPP_NOT_SUPPORTED",e[e.IMAGE_READ_FAILED=-10012]="IMAGE_READ_FAILED",e[e.TIFF_READ_FAILED=-10013]="TIFF_READ_FAILED",e[e.PDF_READ_FAILED=-10021]="PDF_READ_FAILED",e[e.PDF_DLL_MISSING=-10022]="PDF_DLL_MISSING",e[e.RECOGNITION_TIMEOUT=-10026]="RECOGNITION_TIMEOUT",e[e.JSON_PARSE_FAILED=-10030]="JSON_PARSE_FAILED",e[e.JSON_TYPE_INVALID=-10031]="JSON_TYPE_INVALID",e[e.JSON_KEY_INVALID=-10032]="JSON_KEY_INVALID",e[e.JSON_VALUE_INVALID=-10033]="JSON_VALUE_INVALID",e[e.JSON_NAME_KEY_MISSING=-10034]="JSON_NAME_KEY_MISSING",e[e.JSON_NAME_VALUE_DUPLICATED=-10035]="JSON_NAME_VALUE_DUPLICATED",e[e.TEMPLATE_NAME_INVALID=-10036]="TEMPLATE_NAME_INVALID",e[e.PARAMETER_VALUE_INVALID=-10038]="PARAMETER_VALUE_INVALID",e[e.SET_MODE_ARGUMENT_ERROR=-10051]="SET_MODE_ARGUMENT_ERROR",e[e.GET_MODE_ARGUMENT_ERROR=-10055]="GET_MODE_ARGUMENT_ERROR",e[e.CHARACTER_MODEL_FILE_NOT_FOUND=-10100]="CHARACTER_MODEL_FILE_NOT_FOUND"}(i||(i={})),function(e){e[e.LST_MANUAL_SPECIFICATION=1]="LST_MANUAL_SPECIFICATION",e[e.LST_PREDETECTED_REGION=2]="LST_PREDETECTED_REGION",e[e.LST_BARCODE=4]="LST_BARCODE"}(s||(s={}));const r=!!("object"==typeof global&&global.process&&global.process.release&&global.process.release.name&&"undefined"==typeof HTMLCanvasElement),n=!r&&"undefined"==typeof self,o=r?global:n?{}:self;class a{constructor(){this._canvasMaxWH="iPhone"==a.browserInfo.OS||"Android"==a.browserInfo.OS?2048:4096,this._instanceID=void 0,this.bSaveOriCanvas=!1,this.oriCanvas=null,this._region=null,this._timeStartRecognize=null,this._timeEnterInnerDLR=null,this.recognizeRecords={},this.drawRegionsultRecords={},this.bDestroyed=!1,this._setWarnnedEx=new Set,this._lastErrorCode=0,this._lastErrorString="",this._lastInnerDecodeDuration=0,this._clickIptSingleFrameMode=()=>{},this.intervalTime=0,this._intervalGetVideoFrame=0,this.array_getFrameTimeCost=[],this.array_decodeFrameTimeCost=[],this._bPauseScan=!1,this._intervalDetectVideoPause=1e3,this._cvsDrawArea=null,this._divScanArea=null,this._divScanLight=null,this._selCam=null,this._selRsl=null,this._selMinLtr=null,this._optGotMinLtr=null,this._btnClose=null,this._minLetter=0,this._soundOnSuccessfullRead=!r&&new Audio("data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"),this.bPlaySoundOnSuccessfulRead=!1,this.bVibrateOnSuccessfulRead=!1,this.vibrateDuration=300,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this.highlightFillStyle="rgba(254,180,32,0.3)",this.highlightStrokeStyle="rgba(254,180,32,0.9)",this.highlightLineWidth=1,this.beingLazyDrawRegionsults=!1,this.currentSettingsTemplate="cppdefault",this.dce=null,this._onCameraSelChange=()=>{this._divScanLight&&(this._divScanLight.style.display="none"),this._drawRegionsults(),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this._onResolutionSelChange=()=>{this._divScanLight&&(this._divScanLight.style.display="none"),this._drawRegionsults(),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this._onMinLetterSelChange=t=>e(this,void 0,void 0,(function*(){let e=t.target.value;if("got"===e)return;e=JSON.parse(e);let i=JSON.parse(yield this.outputRuntimeSettingsToString());i.LabelRecognizerParameterArray[0].LineStringLengthRange=[e,999],i.TextAreaArray[0].LineStringLengthRange=[e,999],yield this.updateRuntimeSettingsFromString(i)})),this._onCloseBtnClick=()=>{this.stopScanning(!0)},this._tempSolutionStatus="closed"}static getVersion(){return this._version}static get license(){return this._license}static set license(e){if("unload"!=this._loadWasmStatus)throw new Error("`license` is not allowed to change after `createInstance` or `loadWasm` is called.");a._license=e}static initLicense(e){if("unload"!=this._loadWasmStatus)throw new Error("`license` is not allowed to change after `createInstance` or `loadWasm` is called.");a._license=e}static set sessionPassword(e){if("unload"!=this._loadWasmStatus)throw new Error("`sessionPassword` is not allowed to change after `createInstance` or `loadWasm` is called.");a._sessionPassword=e}static get sessionPassword(){return this._sessionPassword}static detectEnvironment(){return e(this,void 0,void 0,(function*(){let e={wasm:"undefined"!=typeof WebAssembly&&("undefined"==typeof navigator||!(/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&/\(.+\s11_2_([2-6]).*\)/.test(navigator.userAgent))),worker:!!(r?process.version>="v12":"undefined"!=typeof Worker),getUserMedia:!("undefined"==typeof navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia),camera:!1,browser:this.browserInfo.browser,version:this.browserInfo.version,OS:this.browserInfo.OS};if(e.getUserMedia)try{(yield navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e.camera=!0}catch(e){}return e}))}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(e){if("unload"!=this._loadWasmStatus)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");if(null==e&&(e="./"),r||n)a._engineResourcePath=e;else{let t=document.createElement("a");t.href=e,a._engineResourcePath=t.href}this._engineResourcePath.endsWith("/")||(a._engineResourcePath+="/")}static get licenseServer(){return this._licenseServer}static set licenseServer(e){if("unload"!=this._loadWasmStatus)throw new Error("`licenseServer` is not allowed to change after `createInstance` or `loadWasm` is called.");if(null==e)a._licenseServer=[];else{e instanceof Array||(e=[e]);for(let t=0;t<e.length;++t){if(!r&&!n){let i=document.createElement("a");i.href=e[t],e[t]=i.href}e[t].endsWith("/")||(e[t]+="/")}a._licenseServer=e}}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(e){if("unload"!=this._loadWasmStatus)throw new Error("`deviceFriendlyName` is not allowed to change after loadWasm is called.");a._deviceFriendlyName=e||""}get ifSaveOriginalImageInACanvas(){return this.bSaveOriCanvas}set ifSaveOriginalImageInACanvas(e){this.dce&&(this.dce.ifSaveOriginalImageInACanvas=e),this.bSaveOriCanvas=e}getOriginalImageInACanvas(){return this.oriCanvas}set region(e){this._region=e,this.dce&&!this.singleFrameMode&&(this.beingLazyDrawRegionsults=!0,setTimeout((()=>{this.beingLazyDrawRegionsults&&this._drawRegionsults()}),500))}get region(){return this._region}static isWasmLoaded(){return"loadSuccess"==this._loadWasmStatus}isContextDestroyed(){return this.bDestroyed}static get lastErrorCode(){return this._lastErrorCode}static get lastErrorString(){return this._lastErrorString}get lastErrorCode(){return this._lastErrorCode}get lastErrorString(){return this._lastErrorString}static get defaultUIElementURL(){var e;return null===(e=this._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",a.engineResourcePath)}static set defaultUIElementURL(e){this._defaultUIElementURL=e}get singleFrameMode(){if(!this.dce)throw new Error("Need to set 'cameraEnhancer' first.");return this.dce.singleFrameMode}set singleFrameMode(t){if(!this.dce)throw new Error("Need to set 'cameraEnhancer' first.");this.dce.singleFrameMode=t,t&&(()=>{e(this,void 0,void 0,(function*(){let e=yield this.getScanSettings();e.trustFrameCount=1,yield this.updateScanSettings(e)}))})()}_assertOpen(){if(!this.dce)throw new Error("Need to set 'cameraEnhancer' first.");if(!this.dce.isOpen())throw Error("The camera is not open.")}_updateMinLtrSel(e){if(this._minLetter=e,this._optGotMinLtr){const t=e?`${e}+ letters`:"any letter";this._optGotMinLtr.innerText=t,this._selMinLtr&&this._optGotMinLtr.parentNode==this._selMinLtr&&(this._selMinLtr.value="got")}}get soundOnSuccessfullRead(){return this._soundOnSuccessfullRead}set soundOnSuccessfullRead(e){e instanceof HTMLAudioElement?this._soundOnSuccessfullRead=e:this._soundOnSuccessfullRead=new Audio(e)}get whenToPlaySoundforSuccessfulRead(){return!0===this.bPlaySoundOnSuccessfulRead?"frame":this.bPlaySoundOnSuccessfulRead?this.bPlaySoundOnSuccessfulRead:"never"}set whenToPlaySoundforSuccessfulRead(e){this.bPlaySoundOnSuccessfulRead="never"!==e&&e}get whenToVibrateforSuccessfulRead(){return!0===this.bVibrateOnSuccessfulRead?"frame":this.bVibrateOnSuccessfulRead?this.bVibrateOnSuccessfulRead:"never"}set whenToVibrateforSuccessfulRead(e){this.bVibrateOnSuccessfulRead="never"!==e&&e}get cameraEnhancer(){return this.dce}set cameraEnhancer(e){if(r)throw new Error("`cameraEnhancer` is not supported in Node.js.");this.dce=e,this.adjustDCESettings()}adjustDCESettings(){this.dce&&(a._onLog&&a._onLog("adjustDCESettings()"),this.dce.bufferRefreshInterval=200,this.dce.alwaysRefreshBuffer=!1,this.dce.ifSaveOriginalImageInACanvas=this.bSaveOriCanvas,this.dce._singleFrameModeIpt=function(){let t=document.createElement("input");return t.setAttribute("type","file"),t.setAttribute("accept","image/*"),t.setAttribute("capture",""),t.addEventListener("change",(()=>e(this,void 0,void 0,(function*(){let e=t.files[0];t.value="",this.onSingleFrameAcquired(e)})))),t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="1px",t.style.height="1px",t.style.backgroundColor="transparent",t.style.color="transparent",this._video.parentElement.appendChild(t),t},this.dce.onSingleFrameAcquired=t=>e(this,void 0,void 0,(function*(){let e=yield this.recognize(t);yield this.clearMapDecodeRecord();for(let t of e)for(let e of t.lineResults)e.bUnduplicated&&delete t.bUnduplicated;if(this._drawRegionsults(e),this.onFrameRead&&this.dce.isOpen()&&!this._bPauseScan&&this.onFrameRead(e),this.onUniqueRead&&this.dce.isOpen()&&!this._bPauseScan)for(let t of e)for(let e of t.lineResults)e.bUnduplicated&&this.onUniqueRead(e.text,this._cloneDecodeResults(e));if(this.onMRZRead&&this.dce.isOpen()&&!this._bPauseScan){if(["passportMRZ","visaMRZ","MRZ"].includes(this.currentSettingsTemplate))for(let t of e){let e="",i=0;for(let s of t.lineResults)e.length>0&&(e+="\n"),e+=s.text,s.bUnduplicated&&i++;i>0&&e.length>0&&this.onMRZRead(e,this._cloneDecodeResults(t.lineResults))}}})),this._clickIptSingleFrameMode=this.dce._clickIptSingleFrameMode)}static loadWasm(){return e(this,void 0,void 0,(function*(){if(r&&process.version<"v12")throw new Error("DLRJS SDK requires nodejs version >= v12.");let t,s=this.license,n=JSON.parse(JSON.stringify(this._licenseServer)),l=this._sessionPassword,c=null,d=null,h=0;if(s.startsWith("t")||s.startsWith("f"))h=0;else if(0===s.length||s.startsWith("P")||s.startsWith("L"))h=1;else{h=2;const e=s.indexOf(":");if(-1!=e&&(s=s.substring(e+1)),s.startsWith("DLS2")){let e=s.substring(4);e=r?Buffer.from(e,"base64").toString("binary"):atob(e);const t=JSON.parse(e);if(t.handshakeCode?s=t.handshakeCode:t.organizationID&&(s=t.organizationID),"number"==typeof s&&(s=JSON.stringify(s)),s||(s=""),0===n.length){let e=[];t.mainServerURL&&(e[0]=t.mainServerURL),t.standbyServerURL&&(e[1]=t.standbyServerURL),this.licenseServer=e,n=this.licenseServer}!l&&t.sessionPassword&&(l=t.sessionPassword),t.chargeWay&&(d=t.chargeWay),t.limitedLicenseModules&&(c=t.limitedLicenseModules)}}if(h&&(r?process.version<"v15"&&(t="To use online key requires nodejs version >= v15."):(o.crypto||(t="Please upgrade your browser to support online key."),o.crypto.subtle||(t="Require https to use online key in this browser."))),t){if(1!==h)throw new Error(t);h=0,console.warn(t),this._lastErrorCode=i.UNKNOWN,this._lastErrorString=t}return 1===h&&(s="",console.warn("Applying for a public trial license ...")),yield new Promise(((t,i)=>e(this,void 0,void 0,(function*(){switch(this._loadWasmStatus){case"unload":{a._loadWasmStatus="loading";let t=this.engineResourcePath+this._workerName;if(r||this.engineResourcePath.startsWith(location.origin)||(t=yield fetch(t).then((e=>e.blob())).then((e=>URL.createObjectURL(e)))),r){const e=require("worker_threads");a._dlrWorker=new e.Worker(t)}else a._dlrWorker=new Worker(t);this._dlrWorker.onerror=e=>{a._loadWasmStatus="loadFail";let t=new Error(e.message);this._loadWasmErr=t;for(let e of this._loadWasmCallbackArr)e(t);this._loadWasmCallbackArr=[]},this._dlrWorker.onmessage=t=>e(this,void 0,void 0,(function*(){let e=t.data?t.data:t;switch(e.type){case"log":this._onLog&&this._onLog(e.message);break;case"load":{e.message&&(e.message=e.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-label-recognizer/#javascript)"));let t=!1;if(1===h&&(t=!0),e.success){a._loadWasmStatus="loadSuccess",a._version=e.version+"(JS "+this._jsVersion+"."+this._jsEditVersion+")",this._onLog&&this._onLog("load dlr worker success");for(let e of this._loadWasmCallbackArr)e();this._loadWasmCallbackArr=[],this._dlrWorker.onerror=null,e.message&&console.warn(e.message)}else{let i=new Error(e.message);i.stack=e.stack+"\n"+i.stack,a._loadWasmStatus="loadFail",this._loadWasmErr=i;for(let e of this._loadWasmCallbackArr)e(i);this._loadWasmCallbackArr=[],t||111==e.ltsErrorCode&&-1!=e.message.toLowerCase().indexOf("trial license")&&(t=!0)}t&&this.showDialog(e.success?"warn":"error",e.message);break}case"task":{let t=e.id,i=e.body;try{this._taskCallbackMap.get(t)(i),this._taskCallbackMap.delete(t)}catch(e){throw this._taskCallbackMap.delete(t),e}break}case"event":"resourcesLoadStarted"===e.body.type?a.onResourcesLoadStarted&&setTimeout((()=>a.onResourcesLoadStarted(e.body.resourcesPath)),0):"resourcesLoadProgress"===e.body.type?a.onResourcesLoadProgress&&setTimeout((()=>a.onResourcesLoadProgress(e.body.resourcesPath,{loaded:e.body.loaded,total:e.body.total})),0):"resourcesLoaded"===e.body.type&&a.onResourcesLoaded&&setTimeout((()=>a.onResourcesLoaded(e.body.resourcesPath)),0);break;default:this._onLog&&this._onLog(t)}})),r&&this._dlrWorker.on("message",this._dlrWorker.onmessage),this._dlrWorker.postMessage({type:"loadWasm",bd:this._bWasmDebug,engineResourcePath:this.engineResourcePath,version:this._jsVersion,brtk:!!h,bptk:1===h,lcs:s,dm:!r&&location.origin.startsWith("http")?location.origin:"https://localhost",browserInfo:this.browserInfo,deviceFriendlyName:this.deviceFriendlyName,ls:n,sp:l,lm:c,cw:d})}case"loading":this._loadWasmCallbackArr.push((e=>{e?i(e):t()}));break;case"loadSuccess":t();break;case"loadFail":i(this._loadWasmErr)}}))))}))}static showDialog(t,i){return e(this,void 0,void 0,(function*(){if(!r&&!this._bNeverShowDialog)try{let e=yield fetch(this.engineResourcePath+"dls.license.dialog.html");if(!e.ok)throw Error("Get license dialog fail. Network Error: "+e.statusText);let s=yield e.text();if(!s.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let r=document.createElement("div");r.innerHTML=s;let n=[];for(let e=0;e<r.childElementCount;++e){let t=r.children[e];t instanceof HTMLStyleElement&&(n.push(t),document.head.append(t))}let o=1==r.childElementCount?r.children[0]:r;o.remove();let a,l,c,d,h,u=[o],g=o.children;for(let e of g)u.push(e);for(let e=0;e<u.length;++e)for(let t of u[e].children)u.push(t);for(let e of u)if(!a&&e.classList.contains("dls-license-mask"))a=e,e.addEventListener("click",(t=>{if(e==t.target){o.remove();for(let e of n)e.remove()}}));else if(!l&&e.classList.contains("dls-license-icon-close"))l=e,e.addEventListener("click",(()=>{o.remove();for(let e of n)e.remove()}));else if(!c&&e.classList.contains("dls-license-icon-error"))c=e,"error"!=t&&e.remove();else if(!d&&e.classList.contains("dls-license-icon-warn"))d=e,"warn"!=t&&e.remove();else if(!h&&e.classList.contains("dls-license-msg-content")){h=e;let t=i;for(;t;){let i=t.indexOf("["),s=t.indexOf("]",i),r=t.indexOf("(",s),n=t.indexOf(")",r);if(-1==i||-1==s||-1==r||-1==n){e.appendChild(new Text(t));break}i>0&&e.appendChild(new Text(t.substring(0,i)));let o=document.createElement("a"),a=t.substring(i+1,s);o.innerText=a;let l=t.substring(r+1,n);o.setAttribute("href",l),o.setAttribute("target","_blank"),e.appendChild(o),t=t.substring(n+1)}}document.body.appendChild(o)}catch(e){this._onLog&&this._onLog(e.message||e)}}))}static createInstanceInWorker(){return e(this,void 0,void 0,(function*(){return yield this.loadWasm(),yield new Promise(((e,t)=>{let i=this._nextTaskID++;this._taskCallbackMap.set(i,(i=>{if(i.success)return e(i.instanceID);{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),this._dlrWorker.postMessage({type:"createInstance",id:i,bScanner:!1})}))}))}static createInstance(t){return e(this,void 0,void 0,(function*(){let e=new a;return e._instanceID=yield this.createInstanceInWorker(),t&&t.runtimeSettings&&e.updateRuntimeSettingsFromString(t.runtimeSettings),e}))}recognize(i,s){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("recognize(source: any, modelName?: string)"),a._onLog&&(this._timeStartRecognize=Date.now()),s=s||{},r)return i instanceof Buffer?yield this._recognizeFileInMemory_Uint8Array(new Uint8Array(i),s):i instanceof Uint8Array?yield this._recognizeFileInMemory_Uint8Array(i,s):"string"==typeof i?"data:image/"==i.substring(0,11)?yield this._recognize_Base64(i,s):"http"==i.substring(0,4)?yield this._recognize_Url(i,s):yield this._recognize_FilePath(i,s):yield Promise.reject(TypeError("'_recognize(source, config)': Type of 'source' should be 'Buffer', 'Uint8Array', 'string(base64 with image mime)' or 'string(url)'."));if(i instanceof Blob)return yield this._recognize_Blob(i,s);if(i instanceof ArrayBuffer)return yield this._recognize_ArrayBuffer(i,s);if(i instanceof Uint8Array||i instanceof Uint8ClampedArray)return yield this._recognize_Uint8Array(i,s);if(i instanceof HTMLImageElement||"undefined"!=typeof ImageBitmap&&i instanceof ImageBitmap)return yield this._recognize_Image(i,s);if(i instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&i instanceof OffscreenCanvas)return yield this._recognize_Canvas(i,s);if(i instanceof HTMLVideoElement)return yield this._recognize_Video(i,s);if("string"==typeof i)return"data:image/"==i.substring(0,11)?yield this._recognize_Base64(i,s):yield this._recognize_Url(i,s);if(i&&"object"==typeof i){const{data:e,canvas:s,region:r,sx:n,sy:o,width:a,height:l}=i;return s&&e?yield this._recognizeBuffer_Uint8Array(e,s.width,s.height,4*s.width,t.IPF_ABGR_8888):e&&a&&l?yield this._recognizeBuffer_Uint8Array(e,a,l,a,t.IPF_GRAYSCALED):yield Promise.reject(TypeError("'_recognize(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'string(base64 with image mime)', 'string(url)' or 'object(dceFrame)'."))}return yield Promise.reject(TypeError("'_recognize(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'string(base64 with image mime)', 'string(url)' or 'object(dceFrame)'."))}))}recognizeBase64String(t,i){return e(this,void 0,void 0,(function*(){let e={};return i&&(e.modelName=i),this._recognize_Base64(t,e)}))}recognizeUrl(t,i){return e(this,void 0,void 0,(function*(){let e={};return i&&(e.modelName=i),this._recognize_Url(t,e)}))}_recognizeBuffer_Uint8Array(t,i,s,r,n,o){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,l)=>{let c=a._nextTaskID++;a._taskCallbackMap.set(c,(t=>{if(t.success){let i,s=a._onLog?Date.now():0;this._lastInnerDecodeDuration=t.duration,this.bufferShared&&!this.bufferShared.length&&(this.bufferShared=t.buffer);try{i=this._handleRetJsonString(t.decodeReturn);const e=e=>!!e&&("VIN_NA"===this.currentSettingsTemplate?this._checkValidVIN(e):"passportMRZ"===this.currentSettingsTemplate?44==e.length&&(/[0-9]/.test(e)?this._checkValidMRP(e):null):"visaMRZ"===this.currentSettingsTemplate?(44==e.length||36==e.length)&&(/[0-9]/.test(e)?this._checkValidMRV(e):null):null);for(let t of i)for(let i of t.lineResults)i.isCheckDigitMatched=e(i.text)}catch(e){return l(e)}if(a._onLog){let e=Date.now();a._onLog("time get result: "+s),a._onLog("Handle image cost: "+(this._timeEnterInnerDLR-this._timeStartRecognize)),a._onLog("worker recognize image cost: "+(s-this._timeEnterInnerDLR)),a._onLog("worker handle results: "+(e-s)),a._onLog("Total recognize image cost: "+(e-this._timeStartRecognize))}return e(i)}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,l(e)}})),a._onLog&&(this._timeEnterInnerDLR=Date.now()),a._onLog&&a._onLog("Send buffer to worker:"+this._timeEnterInnerDLR),a._dlrWorker.postMessage({type:"recognizeByBuffer",id:c,instanceID:this._instanceID,body:{config:o,imageData:{bytes:t,length:s*i*4,width:i,height:s,stride:r,format:n}}},[t.buffer])}))}))}_recognizeBuffer_Blob(t,i,s,r,n,o){return e(this,void 0,void 0,(function*(){a._onLog&&a._onLog("_recognizeBuffer_Blob(buffer,width,height,stride,format)");const e=t.arrayBuffer?yield t.arrayBuffer():yield new Promise(((e,i)=>{let s=new FileReader;s.readAsArrayBuffer(t),s.onload=()=>{e(s.result)},s.onerror=()=>{i(s.error)}}));return yield this._recognizeBuffer_Uint8Array(new Uint8Array(e),i,s,r,n,o)}))}recognizeBuffer(t,i,s,n,o,l){return e(this,void 0,void 0,(function*(){let e;return a._onLog&&a._onLog("recognizeBuffer(buffer,width,height,stride,format)"),a._onLog&&(this._timeStartRecognize=Date.now()),r?t instanceof Uint8Array?e=yield this._recognizeBuffer_Uint8Array(t,i,s,n,o,l):t instanceof Buffer&&(e=yield this._recognizeBuffer_Uint8Array(new Uint8Array(t),i,s,n,o,l)):t instanceof Uint8Array||t instanceof Uint8ClampedArray?e=yield this._recognizeBuffer_Uint8Array(t,i,s,n,o,l):t instanceof ArrayBuffer?e=yield this._recognizeBuffer_Uint8Array(new Uint8Array(t),i,s,n,o,l):t instanceof Blob&&(e=yield this._recognizeBuffer_Blob(t,i,s,n,o,l)),e}))}_recognizeFileInMemory_Uint8Array(t,i){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,s)=>{let r=a._nextTaskID++;a._taskCallbackMap.set(r,(t=>{if(t.success){let i;try{i=this._handleRetJsonString(t.decodeReturn)}catch(e){return s(e)}return e(i)}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,s(e)}})),a._dlrWorker.postMessage({type:"recognizeFileInMemory",id:r,instanceID:this._instanceID,body:{config:i,bytes:t}})}))}))}getRuntimeSettings(){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success){let t=JSON.parse(i.results);return e(t)}{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"getRuntimeSettings",id:i,instanceID:this._instanceID})}))}))}static isRegionNormalPreset(e){return s.LST_MANUAL_SPECIFICATION==e.localizationSourceType&&1==e.regionMeasuredByPercentage&&JSON.stringify([{x:0,y:100},{x:100,y:0},{x:100,y:100},{x:0,y:100}])===JSON.stringify(e.location.points)}updateRuntimeSettings(t){return e(this,void 0,void 0,(function*(){let e;if("string"==typeof t){if(!(t=t.trim()).startsWith("{"))return void this.updateRuntimeSettingsFromString(t);e=JSON.parse(t)}else{if("object"!=typeof t)throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");e=JSON.parse(JSON.stringify(t))}const i=e.referenceRegion;a.isRegionNormalPreset(i)?this.region=null:this.region=i,this._updateMinLtrSel(0),yield new Promise(((t,i)=>{let s=a._nextTaskID++;a._taskCallbackMap.set(s,(e=>{if(e.success){try{this._handleRetJsonString(e.updateReturn)}catch(e){i(e)}return t()}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}})),a._dlrWorker.postMessage({type:"updateRuntimeSettings",id:s,instanceID:this._instanceID,body:{settings:JSON.stringify(e)}})}))}))}resetRuntimeSettings(){return e(this,void 0,void 0,(function*(){return this.region=null,this._updateMinLtrSel(0),yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"resetRuntimeSettings",id:i,instanceID:this._instanceID})}))}))}updateRuntimeSettingsFromString(t){return e(this,void 0,void 0,(function*(){let e=0;if("string"==typeof t)if((t=t.trim()).startsWith("{"))t=JSON.parse(t);else{if(t.length>50)throw new Error("Error: preset longer than 50 letters.");const i=t.toLowerCase().split("-");if(i.length>2)throw new Error(`Error: '${t}' is not supported.`);if(i.includes("numberletter"))e=3,this.currentSettingsTemplate="numberLetter";else if(i.includes("numberuppercase"))e=3,this.currentSettingsTemplate="numberUppercase";else if(i.includes("number"))e=3,this.currentSettingsTemplate="number";else if(i.includes("letter"))e=3,this.currentSettingsTemplate="letter";else if(i.includes("passportmrz"))e=44,this.currentSettingsTemplate="passportMRZ";else if(i.includes("visamrz"))e=36,this.currentSettingsTemplate="visaMRZ";else if(i.includes("mrz"))e=30,this.currentSettingsTemplate="MRZ";else if(i.includes("vin_na"))e=14,this.currentSettingsTemplate="VIN_NA";else if(i.includes("vin"))e=14,this.currentSettingsTemplate="VIN";else{if(!i.includes("cppdefault"))throw new Error(`Error: '${t}' is not supported.`);this.currentSettingsTemplate="cppdefault"}i.includes("video")?this.region={localizationSourceType:s.LST_MANUAL_SPECIFICATION,location:{points:[{x:0,y:40},{x:100,y:40},{x:100,y:60},{x:0,y:60}]},regionMeasuredByPercentage:1}:this.region=null}else{if("object"!=typeof t)throw TypeError("'updateRuntimeSettingsFromString(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");this.currentSettingsTemplate=null}if("object"==typeof t){const i=t.ReferenceRegionArray[0].Localization,r=i.FirstPoint?{localizationSourceType:s[i.SourceType],location:{points:[{x:i.FirstPoint[0],y:i.FirstPoint[1]},{x:i.SecondPoint[0],y:i.SecondPoint[1]},{x:i.ThirdPoint[0],y:i.ThirdPoint[1]},{x:i.FourthPoint[0],y:i.FourthPoint[1]}]},regionMeasuredByPercentage:i.MeasuredByPercentage}:null;r&&a.isRegionNormalPreset(r)?this.region=null:this.region=r;const n=t.LabelRecognizerParameterArray[0].LineStringLengthRange;e=n?n[0]:0}return this._updateMinLtrSel(e),yield new Promise(((e,i)=>{let s=a._nextTaskID++;a._taskCallbackMap.set(s,(t=>{if(t.success){try{this._handleRetJsonString(t.updateReturn)}catch(e){i(e)}return e()}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,i(e)}})),a._dlrWorker.postMessage({type:"updateRuntimeSettingsFromString",id:s,instanceID:this._instanceID,body:{settings:t}})}))}))}outputRuntimeSettingsToString(){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success)return e(i.results);{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"outputSettingsToString",id:i,instanceID:this._instanceID})}))}))}updateReferenceRegionFromBarcodeResults(t){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,i)=>{let s=a._nextTaskID++;a._taskCallbackMap.set(s,(t=>{if(t.success)return e();{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,i(e)}})),a._dlrWorker.postMessage({type:"updateReferenceRegionFromBarcodeResults",id:s,instanceID:this._instanceID,body:{dbrTextResults:t}})}))}))}static appendCaffeModelBuffer(t,i){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,s)=>{let r=a._nextTaskID++;a._taskCallbackMap.set(r,(t=>{if(t.success){try{return e()}catch(e){s(e)}return e()}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,s(e)}})),a._dlrWorker.postMessage({type:"appendCaffeModelBuffer",id:r,body:{name:t,folderUrl:i}})}))}))}static eraseCaffeModelByName(t){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,i)=>{let s=a._nextTaskID++;a._taskCallbackMap.set(s,(t=>{if(t.success)return e();{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,i(e)}})),a._dlrWorker.postMessage({type:"eraseCaffeModelByName",id:s,body:{name:t}})}))}))}static eraseAllCaffeModels(){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"eraseAllCaffeModels",id:i})}))}))}_recognize_Blob(t,i){return e(this,void 0,void 0,(function*(){a._onLog&&a._onLog("_recognize_Blob(blob: Blob)");let e=null,s=null;if("undefined"!=typeof createImageBitmap)try{e=yield createImageBitmap(t)}catch(e){}e||(s=yield function(e){return new Promise(((t,i)=>{let s=URL.createObjectURL(e),r=new Image;r.dlrObjUrl=s,r.src=s,r.onload=()=>{t(r)},r.onerror=e=>{i(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}}))}(t));let r=yield this._recognize_Image(e||s,i);return e&&e.close(),r}))}_recognize_ArrayBuffer(t,i){return e(this,void 0,void 0,(function*(){return yield this._recognize_Blob(new Blob([t]),i)}))}_recognize_Uint8Array(t,i){return e(this,void 0,void 0,(function*(){return yield this._recognize_Blob(new Blob([t]),i)}))}_recognize_Image(t,i){return e(this,void 0,void 0,(function*(){a._onLog&&a._onLog("_recognize_Image(image: HTMLImageElement|ImageBitmap)"),i=i||{};let e,s,r=t instanceof HTMLImageElement?t.naturalWidth:t.width,n=t instanceof HTMLImageElement?t.naturalHeight:t.height,l=Math.max(r,n);if(l>this._canvasMaxWH){let t=this._canvasMaxWH/l;e=Math.round(r*t),s=Math.round(n*t)}else e=r,s=n;let c,d=r,h=n,u=e,g=s;!this.bSaveOriCanvas&&o.OffscreenCanvas?c=new OffscreenCanvas(u,g):(c=document.createElement("canvas"),c.width=u,c.height=g);let _=c.getContext("2d");return r==d&&n==h&&r==u&&n==g?_.drawImage(t,0,0):_.drawImage(t,0,0,d,h,0,0,u,g),t.dlrObjUrl&&URL.revokeObjectURL(t.dlrObjUrl),yield this._recognize_Canvas(c,i)}))}_recognize_Canvas(i,s){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("_recognize_Canvas(canvas:HTMLCanvasElement)"),i.crossOrigin&&"anonymous"!=i.crossOrigin)throw"cors";if(0===i.width||0===i.height)throw Error("The width or height of the 'canvas' is 0.");(this.bSaveOriCanvas||this.dce&&this.singleFrameMode)&&(this.oriCanvas=i);let e=(i.dlrCtx2d||i.getContext("2d")).getImageData(0,0,i.width,i.height).data;return yield this._recognizeBuffer_Uint8Array(e,i.width,i.height,4*i.width,t.IPF_ABGR_8888,s)}))}_recognize_Video(t,i){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("_recognize_Video(video)"),!(t instanceof HTMLVideoElement))throw TypeError("'_recognize_Video(video [, config] )': Type of 'video' should be 'HTMLVideoElement'.");if(t.crossOrigin&&"anonymous"!=t.crossOrigin)throw"cors";i=i||{};let e,s,r=t.videoWidth,n=t.videoHeight,l=Math.max(r,n);if(l>this._canvasMaxWH){let t=this._canvasMaxWH/l;e=Math.round(r*t),s=Math.round(n*t)}else e=r,s=n;let c=r,d=n,h=e,u=s,g=r==c&&n==d&&r==h&&n==u,_=null;!this.bSaveOriCanvas&&o.OffscreenCanvas?_=new OffscreenCanvas(h,u):(_=document.createElement("canvas"),_.width=h,_.height=u);const f=_.dlrCtx2d=_.getContext("2d");return g?f.drawImage(t,0,0):f.drawImage(t,0,0,c,d,0,0,h,u),yield this._recognize_Canvas(_,i)}))}_recognize_Base64(t,i){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("_recognize_Base64(base64Str)"),"string"!=typeof t&&"object"!=typeof t)return Promise.reject("'_recognize_Base64(base64Str, config)': Type of 'base64Str' should be 'string'.");if("data:image/"==t.substring(0,11)&&(t=t.substring(t.indexOf(",")+1)),r){let e=Buffer.from(t,"base64");return yield this._recognizeFileInMemory_Uint8Array(new Uint8Array(e),i)}{let e=atob(t),s=e.length,r=new Uint8Array(s);for(;s--;)r[s]=e.charCodeAt(s);return yield this._recognize_Blob(new Blob([r]),i)}}))}_recognize_Url(t,i){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("_recognize_Url(url)"),"string"!=typeof t&&"object"!=typeof t)throw TypeError("'_recognize_Url(url, config)': Type of 'url' should be 'string'.");if(r){let e=yield new Promise(((e,i)=>{(t.startsWith("https")?require("https"):require("http")).get(t,(t=>{if(200==t.statusCode){let i=[];t.on("data",(e=>{i.push(e)})).on("end",(()=>{e(new Uint8Array(Buffer.concat(i)))}))}else i("http get fail, statusCode: "+t.statusCode)}))}));return yield this._recognizeFileInMemory_Uint8Array(e,i)}{let s=yield new Promise(((i,s)=>{let r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.send(),r.onloadend=()=>e(this,void 0,void 0,(function*(){i(r.response)})),r.onerror=()=>{s(new Error("Network Error: "+r.statusText))}}));return yield this._recognize_Blob(s,i)}}))}_recognize_FilePath(t,i){return e(this,void 0,void 0,(function*(){if(a._onLog&&a._onLog("_recognize_FilePath(path)"),!r)throw Error("'_recognize_FilePath(path, config)': The method is only supported in node environment.");if("string"!=typeof t&&"object"!=typeof t)throw TypeError("'_recognize_FilePath(path, config)': Type of 'path' should be 'string'.");const e=require("fs");let s=yield new Promise(((i,s)=>{e.readFile(t,((e,t)=>{e?s(e):i(new Uint8Array(t))}))}));return yield this._recognizeFileInMemory_Uint8Array(s,i)}))}static LabelRecognizerException(e,t){let s,r=i.UNKNOWN;return"number"==typeof e?(r=e,s=new Error(t)):s=new Error(e),s.code=r,s}_handleRetJsonString(e){let t=i;if(e.results){const t=this.drawRegionsultRecords,s={};for(let i=0;i<e.results.length;i++){let r=e.results[i];if(null!=r.exception){this._setWarnnedEx.has(r.exception)||(this._setWarnnedEx.add(r.exception),console.warn(r.exception));let e={};r.exception.split(";").forEach((t=>{let i=t.indexOf(":");e[t.substring(0,i)]=t.substring(i+1)})),r.exception=e}for(let e of r.lineResults){const i=e.text;if(s[i]=1,e.bUnduplicated){(t[i]=t[i]||[]).push(e)}else t[i]&&(t[i]=[e])}}if(e.records){const i=this.recognizeRecords=e.records;for(let e in t)i[e]||delete t[e];for(let e in t)s[e]||(t[e]=[])}else this.recognizeRecords={},this.drawRegionsultRecords={};return this._lastErrorCode=e.exception,this._lastErrorString=e.description,e.exception&&!this._setWarnnedEx.has(e.description)&&(this._setWarnnedEx.add(e.description),e.exception==i.LICENSE_INVALID||e.exception==i.LICENSE_EXPIRED?console.error(e.description):console.warn(e.description)),e.results}if(e.exception==t.OK)return e.data;throw a.LabelRecognizerException(e.exception,e.description)}setModeArgument(t,i,s,r){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,n)=>{let o=a._nextTaskID++;a._taskCallbackMap.set(o,(t=>{if(t.success){try{this._handleRetJsonString(t.setReturn)}catch(e){return n(e)}return e()}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,n(e)}})),a._dlrWorker.postMessage({type:"setModeArgument",id:o,instanceID:this._instanceID,body:{modeName:t,index:i,argumentName:s,argumentValue:r}})}))}))}getModeArgument(t,i,s){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,r)=>{let n=a._nextTaskID++;a._taskCallbackMap.set(n,(t=>{if(t.success){let i;try{i=this._handleRetJsonString(t.getReturn)}catch(e){return r(e)}return e(i)}{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,r(e)}})),a._dlrWorker.postMessage({type:"getModeArgument",id:n,instanceID:this._instanceID,body:{modeName:t,index:i,argumentName:s}})}))}))}recognizeCurrentFrame(){return e(this,void 0,void 0,(function*(){this._assertOpen();let e=this.dce.getFrame();if(e&&null===e.canvas){let{data:i,width:s,height:r}=e;return yield this._recognizeBuffer_Uint8Array(i,s,r,s,t.IPF_GRAYSCALED)}if(e&&e.canvas){let{data:i,canvas:s}=e;return(this.bSaveOriCanvas||this.singleFrameMode)&&(this.oriCanvas=s),yield this._recognizeBuffer_Uint8Array(i,s.width,s.height,4*s.width,t.IPF_ABGR_8888)}}))}clearMapDecodeRecord(){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"clearMapDecodeRecord",id:i,instanceID:this._instanceID})}))}))}_bindUI(){const e=this.dce.getUIElement();if(!e)throw new Error("Need to define `UIElement` before opening.");this.dce._bindUI();let t=[e],i=e.children;for(let e of i)t.push(e);for(let e=0;e<t.length;++e)for(let i of t[e].children)t.push(i);for(let e of t)!this._cvsDrawArea&&e.classList.contains("dlr-cvs-drawarea")?this._cvsDrawArea=e:!this._divScanArea&&e.classList.contains("dlr-cvs-scanarea")?this._divScanArea=e:!this._divScanLight&&e.classList.contains("dlr-scanlight")?this._divScanLight=e:!this._selCam&&e.classList.contains("dce-sel-camera")?this._selCam=e:!this._selRsl&&e.classList.contains("dce-sel-resolution")?this._selRsl=e:!this._selMinLtr&&e.classList.contains("dlr-sel-minletter")?(this._selMinLtr=e,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="18">18+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):this._optGotMinLtr||!e.classList.contains("dlr-opt-gotMinLtr")&&!e.classList.contains("dlr-opt-gotMinLtr")?!this._btnClose&&e.classList.contains("dce-btn-close")&&(this._btnClose=e):this._optGotMinLtr=e;if(this.singleFrameMode&&(this._cvsDrawArea&&(this._cvsDrawArea.addEventListener("click",this._clickIptSingleFrameMode),this._cvsDrawArea.style.cursor="pointer",this._cvsDrawArea.setAttribute("title","Take a photo")),this._divScanArea&&(this._divScanArea.addEventListener("click",this._clickIptSingleFrameMode),this._divScanArea.style.cursor="pointer",this._divScanArea.setAttribute("title","Take a photo"))),this._selCam&&this._selCam.addEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.addEventListener("change",this._onResolutionSelChange),this._selMinLtr&&this._selMinLtr.addEventListener("change",this._onMinLetterSelChange),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),!this.dce.video)throw this._unbindUI(),Error("Can not find HTMLVideoElement with class `dce-video`.");this._updateMinLtrSel(this._minLetter)}_unbindUI(){this._clearRegionsults(),this.singleFrameMode&&(this._cvsDrawArea&&(this._cvsDrawArea.removeEventListener("click",this._clickIptSingleFrameMode),this._cvsDrawArea.style.cursor="",this._cvsDrawArea.removeAttribute("title")),this._divScanArea&&(this._divScanArea.removeEventListener("click",this._clickIptSingleFrameMode),this._divScanArea.style.cursor="",this._divScanArea.removeAttribute("title"))),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._selMinLtr&&this._selMinLtr.removeEventListener("change",this._onMinLetterSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.dce._unbindUI(),this._cvsDrawArea=null,this._divScanArea=null,this._divScanLight=null,this._selCam=null,this._selRsl=null,this._selMinLtr=null,this._optGotMinLtr=null,this._btnClose=null}getScanSettings(){return e(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success){let t=i.results;return t.intervalTime=this.intervalTime,e(t)}{let e=new Error(i.message);return e.stack+="\n"+i.stack,t(e)}})),a._dlrWorker.postMessage({type:"getScanSettings",id:i,instanceID:this._instanceID})}))}))}updateScanSettings(t){return e(this,void 0,void 0,(function*(){return this.intervalTime=t.intervalTime,yield new Promise(((e,i)=>{let s=a._nextTaskID++;a._taskCallbackMap.set(s,(t=>{if(t.success)return e();{let e=new Error(t.message);return e.stack+="\n"+t.stack,i(e)}})),a._dlrWorker.postMessage({type:"updateScanSettings",id:s,instanceID:this._instanceID,body:{settings:t}})}))}))}_show(){const e=this.dce.getUIElement();e.parentNode||(e.style.position="fixed",e.style.left="0",e.style.top="0",document.body.append(e)),"none"==e.style.display&&(e.style.display="")}stop(){this.dce&&this.dce.stop(),this._divScanLight&&(this._divScanLight.style.display="none"),this._drawRegionsults(),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}_cloneDecodeResults(e){if(e instanceof Array){let t=[];for(let i of e)t.push(this._cloneDecodeResults(i));return t}{let t=e;return JSON.parse(JSON.stringify(t,((e,t)=>"oriVideoCanvas"==e||"searchRegionCanvas"==e?void 0:t)))}}_loopReadVideo(){return e(this,void 0,void 0,(function*(){if(this.bDestroyed)return void(this.dce&&this.dce.stopFetchingLoop());if(!this.dce||!this.dce.isOpen())return this.dce&&this.dce.stopFetchingLoop(),void(yield this.clearMapDecodeRecord());if(!this.dce.video||this.dce.video.paused||this._bPauseScan)return a._onLog&&a._onLog("Video or scan is paused. Ask in 1s."),this.dce&&this.dce.stopFetchingLoop(),yield this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this._intervalDetectVideoPause));this._divScanLight&&"none"==this._divScanLight.style.display&&(this._divScanLight.style.display=""),a._onLog&&a._onLog("======= once read ======="),a._onLog&&(this._timeStartRecognize=Date.now());let i=this._getVideoFrame();if(!i)return this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0));(()=>e(this,void 0,void 0,(function*(){if(i&&null===i.canvas){let{data:e,width:s,height:r,timeStamp:n}=i,o={timeStamp:n,bScanner:!0};return yield this._recognizeBuffer_Uint8Array(e,s,r,s,t.IPF_GRAYSCALED,o)}if(i&&i.canvas){let{data:e,canvas:s,region:r,sx:n,sy:o,width:a,height:l,timeStamp:c}=i,d={timeStamp:c,bScanner:!0};return(this.bSaveOriCanvas||this.singleFrameMode)&&(this.oriCanvas=s),yield this._recognizeBuffer_Uint8Array(e,s.width,s.height,4*s.width,t.IPF_ABGR_8888,d)}{let e=new Error("imgData is empty.");return new Promise((t=>t(e)))}})))().then((e=>{a._onLog&&a._onLog(e);let t=this.array_decodeFrameTimeCost,i=this.array_getFrameTimeCost;if((()=>{for(;t.length>=5;)t.shift();t.push(this._lastInnerDecodeDuration)})(),this._intervalGetVideoFrame=(()=>{let e=0;if(i&&i.length){let s=Math.min(...t),r=Math.max(...i);s&&r&&(e=s-r)}else e=0;return e>0?e:0})(),this.dce&&this.dce.isOpen()&&this.dce.video&&!this.dce.video.paused&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&e.length){let t=!1;if(!0===this.bPlaySoundOnSuccessfulRead||"frame"===this.bPlaySoundOnSuccessfulRead)t=!0;else if("unique"===this.bPlaySoundOnSuccessfulRead)for(let i of e)for(let e of i.lineResults)if(e.bUnduplicated){t=!0;break}t&&(this.soundOnSuccessfullRead.currentTime=0,this.soundOnSuccessfullRead.play().catch((e=>{console.warn("Autoplay not allowed. User interaction required.")})))}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&e.length){let t=!1;if(!0===this.bVibrateOnSuccessfulRead||"frame"===this.bVibrateOnSuccessfulRead)t=!0;else if("unique"===this.bVibrateOnSuccessfulRead)for(let i of e)for(let e of i.lineResults)if(e.bUnduplicated){t=!0;break}if(t)try{navigator.vibrate(this.vibrateDuration)}catch(e){console.warn("Vibration not allowed. User interaction required: "+(e.message||e))}}if(this.onFrameRead){let t=this._cloneDecodeResults(e);for(let e of t)for(let t of e.lineResults)t.bUnduplicated&&delete e.bUnduplicated;this.onFrameRead(t)}if(this.onUniqueRead)for(let t of e)for(let e of t.lineResults)e.bUnduplicated&&this.onUniqueRead(e.text,this._cloneDecodeResults(e));if(this.onMRZRead){if(["passportMRZ","visaMRZ","MRZ"].includes(this.currentSettingsTemplate))for(let t of e){let e="",i=0;for(let s of t.lineResults)e.length>0&&(e+="\n"),e+=s.text,s.bUnduplicated&&i++;i>0&&e.length>0&&this.onMRZRead(e,this._cloneDecodeResults(t.lineResults))}}{const e=[];for(let t in this.drawRegionsultRecords)e.push(...this.drawRegionsultRecords[t]);this._drawRegionsults([{lineResults:e}])}}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this.intervalTime):this._loopReadVideo()})).catch((e=>{this.dce.stopFetchingLoop(),a._onLog&&a._onLog(e.message||e),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),Math.max(this.intervalTime,1e3)),"platform error"==e.message||console.warn(e.message)}))}))}_getVideoFrame(){let e=this.dce.isFetchingLoopStarted();if(this.dce.loopInterval=this._intervalGetVideoFrame,e||this.dce.startFetchingLoop(),!this.dce.getQueueLength())return this.dce.loopInterval=0,null;let t=this.dce.getFrameFromBuffer();return(e=>{let t=e.timeSpent,i=this.array_getFrameTimeCost;for(;i.length>=5;)i.shift();i.push(t)})(t),t}_checkValidVIN(e){if(!e||17!=e.length)return!1;const t=(e=>{const t=new Map([["A",1],["B",2],["C",3],["D",4],["E",5],["F",6],["G",7],["H",8],["J",1],["K",2],["L",3],["M",4],["N",5],["P",7],["R",9],["S",2],["T",3],["U",4],["V",5],["W",6],["X",7],["Y",8],["Z",9],["1",1],["2",2],["3",3],["4",4],["5",5],["6",6],["7",7],["8",8],["9",9]]),i=[8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];let s=0;for(let r=0;r<e.length;r++){let n=t.get(e[r]);n&&(s+=n*i[r])}return s%11})(e);return t.toString()===e[8]}_checkValidMRP(e){if(!e||44!=e.length)return!1;const t=(e,t,i)=>{const s=new Map([["<",0],["0",0],["1",1],["2",2],["3",3],["4",4],["5",5],["6",6],["7",7],["8",8],["9",9],["A",10],["B",11],["C",12],["D",13],["E",14],["F",15],["G",16],["H",17],["I",18],["J",19],["K",20],["L",21],["M",22],["N",23],["O",24],["P",25],["Q",26],["R",27],["S",28],["T",29],["U",30],["V",31],["W",32],["X",33],["Y",34],["Z",35]]),r=[7,3,1];let n=0;for(let o=t,a=0;o<=i;o++){let t=s.get(e[o]);t&&(n+=t*r[a%3]),a++}return n%10},i=e.slice(0,10)+e.slice(13,20)+e.slice(21,43),s=t(e,0,8).toString(),r=t(e,13,18).toString(),n=t(e,21,26).toString(),o=t(e,28,41).toString(),a=t(i,0,i.length).toString();return s===e[9]&&r===e[19]&&n===e[27]&&o===e[42]&&a===e[43]}_checkValidMRV(e){if(!e||44!=e.length&&36!=e.length)return!1;const t=(e,t,i)=>{const s=new Map([["<",0],["0",0],["1",1],["2",2],["3",3],["4",4],["5",5],["6",6],["7",7],["8",8],["9",9],["A",10],["B",11],["C",12],["D",13],["E",14],["F",15],["G",16],["H",17],["I",18],["J",19],["K",20],["L",21],["M",22],["N",23],["O",24],["P",25],["Q",26],["R",27],["S",28],["T",29],["U",30],["V",31],["W",32],["X",33],["Y",34],["Z",35]]),r=[7,3,1];let n=0;for(let o=t,a=0;o<=i;o++){let t=s.get(e[o]);t&&(n+=t*r[a%3]),a++}return n%10},i=t(e,0,8).toString(),s=t(e,13,18).toString(),r=t(e,21,26).toString();return i===e[9]&&s===e[19]&&r===e[27]}_drawRegionsults(e){let t,i,r;if(this.beingLazyDrawRegionsults=!1,this.singleFrameMode){if(!this.oriCanvas)return;t="contain",i=this.oriCanvas.width,r=this.oriCanvas.height}else{if(!this.dce.video)return;t=this.dce.video.style.objectFit||"contain",i=this.dce.video.videoWidth,r=this.dce.video.videoHeight}if(i<=0||i<=0)return;let n,o,a,l,c,d,h,u,g=this.region;if(g)if(s.LST_MANUAL_SPECIFICATION!=g.localizationSourceType)g=null;else if(g.regionMeasuredByPercentage){let e=g.location.points;if(0==e[0].x&&0==e[0].y&&100==e[1].x&&0==e[1].y&&100==e[2].x&&100==e[2].y&&0==e[3].x&&100==e[3].y)g=null;else{g={location:{points:[]}};for(let t=0;t<4;++t)g.location.points.push({x:Math.round(e[t].x/100*i),y:Math.round(e[t].y/100*r)})}}else g=JSON.parse(JSON.stringify(g)),delete g.regionMeasuredByPercentage;if(g){let e=g.location.points;n=e[0].x,c=e[0].y,o=e[1].x,d=e[1].y,a=e[2].x,h=e[2].y,l=e[3].x,u=e[3].y}if(this._cvsDrawArea){this._cvsDrawArea.style.objectFit=t;let s=this._cvsDrawArea;s.width=i,s.height=r;let _=s.getContext("2d");if(g){_.fillStyle=this.regionMaskFillStyle,_.fillRect(0,0,s.width,s.height);let e=Math.round(this.regionMaskLineWidth/2),t=(t,i,s,r,n,o)=>(-(s-t)*e/Math.hypot(s-t,r-i)-(n-t)*e/Math.hypot(n-t,o-i))/2+t,i=(t,i,s,r,n,o)=>(-(r-i)*e/Math.hypot(s-t,r-i)-(o-i)*e/Math.hypot(n-t,o-i))/2+i;_.globalCompositeOperation="destination-out",_.fillStyle="#000",_.beginPath(),_.moveTo(t(n,c,o,d,l,u),i(n,c,o,d,l,u)),_.lineTo(t(o,d,n,c,a,h),i(o,d,n,c,a,h)),_.lineTo(t(a,h,o,d,l,u),i(a,h,o,d,l,u)),_.lineTo(t(l,u,a,h,n,c),i(l,u,a,h,n,c)),_.fill(),_.globalCompositeOperation="source-over",_.strokeStyle=this.regionMaskStrokeStyle,_.lineWidth=this.regionMaskLineWidth,_.beginPath(),_.moveTo(n,c),_.lineTo(o,d),_.lineTo(a,h),_.lineTo(l,u),_.closePath(),_.stroke()}if(e){_.globalCompositeOperation="destination-over",_.fillStyle=this.highlightFillStyle,_.strokeStyle=this.highlightStrokeStyle,_.lineWidth=this.highlightLineWidth,e=e||[];for(let t of e)for(let e of t.lineResults){let t=e.location.points;_.beginPath(),_.moveTo(t[0].x,t[0].y),_.lineTo(t[1].x,t[1].y),_.lineTo(t[2].x,t[2].y),_.lineTo(t[3].x,t[3].y),_.fill(),_.beginPath(),_.moveTo(t[0].x,t[0].y),_.lineTo(t[1].x,t[1].y),_.lineTo(t[2].x,t[2].y),_.lineTo(t[3].x,t[3].y),_.closePath(),_.stroke()}}this.singleFrameMode&&(_.globalCompositeOperation="destination-over",_.drawImage(this.oriCanvas,0,0))}if(this._divScanArea&&this.dce.video){let e=this.dce.video.offsetWidth,t=this.dce.video.offsetHeight,s=1;e/t<i/r?(s=e/i,this._divScanArea.style.left="0",this._divScanArea.style.top=Math.round((t-r*s)/2)+"px"):(s=t/r,this._divScanArea.style.left=Math.round((e-i*s)/2)+"px",this._divScanArea.style.top="0");let _=g?Math.round(Math.min(n,o,a,l)*s):0,f=g?Math.round(Math.min(c,d,h,u)*s):0,m=g?Math.round(Math.max(n,o,a,l)*s-_):Math.round(i*s),p=g?Math.round(Math.max(c,d,h,u)*s-f):Math.round(r*s);this._divScanArea.style.marginLeft=_+"px",this._divScanArea.style.marginTop=f+"px",this._divScanArea.style.width=m+"px",this._divScanArea.style.height=p+"px"}}_clearRegionsults(){this._cvsDrawArea&&(this._cvsDrawArea.width=this._cvsDrawArea.height=0)}startScanning(t){return e(this,void 0,void 0,(function*(){if("closed"!=this._tempSolutionStatus)return;if(this._tempSolutionStatus="opening",!this.dce)throw new Error("Need to set 'cameraEnhancer' first.");if("opening"!=this._tempSolutionStatus)return;this._bindUI(),t&&this._show();let e=yield this.dce.play();return"opening"==this._tempSolutionStatus?(this._bPauseScan=!1,this.singleFrameMode||(this._loopReadVideo(),this._drawRegionsults()),this._tempSolutionStatus="opened",e):void 0}))}stopScanning(e){this.stop(),this._unbindUI(),this.dce&&this.dce.stopFetchingLoop(),this._bPauseScan=!0,e&&this.dce&&(this.dce.getUIElement().style.display="none"),this._tempSolutionStatus="closed"}pauseScanning(){this.dce&&this.dce.stopFetchingLoop(),this._bPauseScan=!0,this._clearRegionsults(),this._divScanLight&&(this._divScanLight.style.display="none")}resumeScanning(){this._assertOpen(),this._bPauseScan=!1}destroyContext(){if(!this.bDestroyed)return a._onLog&&a._onLog("destroy()"),this.bDestroyed=!0,(this.dce||"opening"===this._tempSolutionStatus)&&this.stopScanning(),new Promise(((e,t)=>{let i=a._nextTaskID++;a._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),a._dlrWorker.postMessage({type:"destroy",id:i,instanceID:this._instanceID})}))}}var l,c;a._jsVersion="2.2.2",a._jsEditVersion="20220302",a._version="loading...(JS "+a._jsVersion+"."+a._jsEditVersion+")",a._license=r||n||!document.currentScript?"":document.currentScript.getAttribute("data-license")||"",a._sessionPassword=r||n||!document.currentScript?"":document.currentScript.getAttribute("data-sessionPassword")||"",a.browserInfo=function(){if(!r&&!n){var t={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"unknownVersion",this.OS=this.searchString(this.dataOS)||"unknownOS","Linux"==this.OS&&-1!=navigator.userAgent.indexOf("Windows NT")&&(this.OS="HarmonyOS")},searchString:function(e){for(var t=0;t<e.length;t++){var i=e[t].string,s=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,i){if(-1!=i.indexOf(e[t].subString))return e[t].identity}else if(s)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Edge",identity:"Edge"},{string:navigator.userAgent,subString:"OPR",identity:"OPR"},{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:navigator.userAgent,subString:"HarmonyOS",identity:"HarmonyOS"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};return t.init(),{browser:t.browser,version:t.version,OS:t.OS}}if(n)return{browser:"ssr",version:0,OS:"ssr"};if(r){const t={browser:"node",version:process.version.substring(1),OS:"loading"};return(()=>{e(this,void 0,void 0,(function*(){const e=yield import("os");t.OS=e&&e.platform?e.platform()+e.release():"Unknown"}))})(),t}}(),a._workerName="dlr-"+a._jsVersion+".worker.js",a._engineResourcePath=(()=>{if(r){const t=import.meta.url;return new Promise((i=>e(void 0,void 0,void 0,(function*(){const e=yield import("url");"string"!=typeof a._engineResourcePath&&(a._engineResourcePath=e.fileURLToPath(t.substring(0,t.lastIndexOf("/")+1))),i()}))))}if(!n&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),a._licenseServer=[],a._deviceFriendlyName="",a._isShowRelRecognizeTimeInResults=!1,a._bWasmDebug=!1,a._bNeverShowDialog=!1,a._nextTaskID=0,a._taskCallbackMap=new Map,a._loadWasmStatus="unload",a._loadWasmCallbackArr=[],a.onResourcesLoadStarted=null,a.onResourcesLoadProgress=null,a.onResourcesLoaded=null,a._lastErrorCode=0,a._lastErrorString="",a._defaultUIElementURL="@engineResourcePath/dlr.ui.html",a._loadWasmErr=null,function(e){e[e.GTM_INVERTED=1]="GTM_INVERTED",e[e.GTM_ORIGINAL=2]="GTM_ORIGINAL",e[e.GTM_AUTO=4]="GTM_AUTO",e[e.GTM_REV=2147483648]="GTM_REV",e[e.GTM_SKIP=0]="GTM_SKIP"}(l||(l={})),function(e){e[e.RPM_AUTO=1]="RPM_AUTO",e[e.RPM_GENERAL=2]="RPM_GENERAL",e[e.RPM_GENERAL_RGB_CONTRAST=4]="RPM_GENERAL_RGB_CONTRAST",e[e.RPM_GENERAL_GRAY_CONTRAST=8]="RPM_GENERAL_GRAY_CONTRAST",e[e.RPM_GENERAL_HSV_CONTRAST=16]="RPM_GENERAL_HSV_CONTRAST",e[e.RPM_REV=2147483648]="RPM_REV",e[e.RPM_SKIP=0]="RPM_SKIP"}(c||(c={}));export{i as EnumDLRErrorCode,l as EnumDLRGrayscaleTransformationMode,t as EnumDLRImagePixelFormat,c as EnumDLRRegionPredetectionMode,a as LabelRecognizer};
